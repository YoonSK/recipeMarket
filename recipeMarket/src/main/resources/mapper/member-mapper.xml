<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="memberMapper">

	<resultMap type="Member" id="memberRS">
		<id property = "memberNo" column="MEMBER_NO"/>
		<result property = "id" column="ID"/>	
		<result property = "pwd" column ="PWD"/>
		<result property = "name" column ="NAME"/>
		<result property = "nickName" column ="NICKNAME"/>		
		<result property = "email" column ="EMAIL"/>
		<result property = "birth" column ="BIRTH"/>		
		<result property = "phone" column ="PHONE"/>
		<result property = "zip" column ="ZIP"/>		
		<result property = "address" column ="ADDRESS"/>
		<result property = "address2" column ="ADDRESS2"/>		
		<result property = "grade" column ="GRADE"/>
		<result property = "deleted" column ="DELETED"/>
	</resultMap> 	
	
  	<select id="memberLogin" parameterType="Member" resultMap="memberRS">
		select * 
		from member
		where id = #{id}
			  and deleted = 'N'			  
	</select>
 	<insert id="memberJoin" parameterType="Member">
		insert into member
		values(seq_mno.nextval, #{id}, #{pwd}, #{name}, #{nickName}, #{email}, #{phone}, #{birth}, 
				#{zip}, #{address}, #{address2}, 1, default)
	</insert> 


	<select id="checkIdDup" parameterType="string" resultType="_int">
		select count(*)
		from member
		where id=#{id}
	</select>
	
	<select id="checkNickDup" parameterType="string" resultType="_int">
		select count(*)
		from member
		where nickName=#{nickName}
	</select>
	
	<resultMap type="Photo" id="photoRS">
		<id property = "photoNo" column="PHOTO_NO"/>
		<result property = "boardNo" column="BOARD_NO"/>	
		<result property = "targetNo" column ="TARGET_NO"/>
		<result property = "fileLevel" column ="FILE_LEVEL"/>
		<result property = "originName" column ="ORIGIN_NAME"/>		
		<result property = "changeName" column ="CHANGE_NAME"/>	
		<result property = "deleted" column ="DELETED"/>
	</resultMap>  
 	
	<insert id="uploadImage" parameterType="Photo">
		insert into photo
		values(seq_phn.nextval, 0, seq_mno.currval, 0, #{originName}, #{changeName}, default)
	</insert>
 
   	<select id="getPhoto" parameterType="Photo" resultType="string">
		select change_name
		from photo
		where target_no = #{memberNo}
			  and deleted = 'N'			  
	</select>
	
	<update id="mDelete" parameterType="Member">
		update member
		set deleted='Y'
		where member_no = ${no}
	</update>	

	<update id="mUpdate" parameterType="Member">
		update member
		set name=#{name}, nickName=#{nickName}, email=#{email}, phone=#{phone},
			zip=#{zip}, address=#{address}, address2=#{address2}
		where member_no=#{memberNo}
	</update>

	<update id="updateImage" parameterType="Photo">
		update photo
		set origin_name = #{originName}, change_name = #{changeName}
		where target_no=#{targetNo}
	</update>
	
	<insert id="mUploadImage" parameterType="Photo">
		insert into photo
		values(seq_phn.nextval, 0, #{targetNo}, 0, #{originName}, #{changeName}, default)
	</insert>	
	
	<update id="pwdUpdate" parameterType="Member">
		update member
		set pwd=#{pwd}
		where member_no=#{memberNo}
	</update>
	
	<select id="findId" parameterType="Member" resultType="string">
		select id from member where name=#{name} and email=#{email}
	</select>
	
	<update id="updatePwd" parameterType="Member">
		update member set pwd=#{pwd} where id=#{id}
	</update>

	

	<resultMap type="OrderInfo" id="oiRS">
		<result property = "orderNo" column="ORDER_NO"/>
		<result property = "date" column="DATE"/>	
		<result property = "total" column ="TOTAL"/>
		<result property = "oList" column ="oList"/>	
		<result property = "status" column ="STATUS"/>												
	</resultMap>  
	
	<select id="mOrderCount" resultType="_int">
		select count(*)
		from "ORDER"
		where mem_no=#{memberNo}
	</select>
	
	<select id="orderList" resultMap="oiRS">
		SELECT 
				ORDER_NO, 
		        "DATE",
		        TOTAL,
		        LISTAGG(NAME, ', ') WITHIN GROUP (ORDER BY ORDER_NO) AS "oList", STATUS
		FROM ODLIST
		where mem_no = #{memberNo}
		group by "DATE", TOTAL, STATUS, ORDER_NO 
		order by ORDER_NO
	</select>
	
	<resultMap type="mOrderDetail" id="odRS">
		<result property = "orderNo" column="ORDER_NO"/>
		<result property = "date" column="DATE"/>	
		<result property = "total" column ="TOTAL"/>
		<result property = "oList" column ="oList"/>	
		<result property = "pName" column ="PNAME"/>		
		<result property = "mName" column ="MNAME"/>
		<result property = "detailNo" column ="DETAIL_NO"/>
		<result property = "prCount" column ="PR_COUNT"/>
		<result property = "price" column ="PRICE"/>
		<result property = "memNo" column ="MEM_NO"/>
		<result property = "status" column ="STATUS"/>
		<result property = "zip" column ="ZIP"/>
		<result property = "address" column ="ADDRESS"/>
		<result property = "address2" column ="ADDRESS2"/>
		<result property = "note" column ="NOTE"/>
		<result property = "phone" column ="PHONE"/>
		<result property = "coupon" column ="COUPON"/>											
	</resultMap> 
		
	<select id="orderDetail" resultMap="odRS">
		SELECT P.NAME AS "PNAME", M.NAME AS "MNAME", "DATE", DETAIL_NO, O.ORDER_NO, PR_COUNT, P.PRICE, MEM_NO, STATUS, O.ZIP, O.ADDRESS, O.ADDRESS2, 
		        O.NOTE, O.PHONE, O.TOTAL, O.COUPON
		FROM ORDER_DETAIL OD
		            JOIN "ORDER" O ON(OD.ORDER_NO = O.ORDER_NO)
		            JOIN "MEMBER" M ON(MEM_NO = MEMBER_NO)
		            JOIN PRODUCT P ON(P.PRODUCT_NO = OD.PRODUCT_NO)
		WHERE O.ORDER_NO = #{no}   	
	</select>

</mapper>
